-module(cb_tutorial_user_controller, [Req]).
-compile(export_all).

login('GET', []) ->
    {ok, [{redirect, Req:header(referer)}]};

login('POST', []) ->
    Email = Req:post_param("email"),
    Password = Req:post_param("password"),
    case boss_db:find(usr, [{email, Email}], 1) of
	[Usr] ->
	    case Usr:check_password(Password) of
		true ->
		    Cookies = Usr:login_cookies(),
		    RedirectTo = Req:post_param("redirect"),
		    {redirect, RedirectTo, Cookies};
		false ->
		    {ok, [{error, "Wrong password"}]}
	    end;
	[] ->
	    {ok, [{error, "User with email " ++ Email ++ " not found: "}]}
    end.
